**The source code is provided as is and was put together quickly for testing purposes only!**

## Introduction

This application is used to simulate possible BuildXL I/O load on macOS. The scenario followed here would be similar to a BuildXL "clean build", where all input files have to be read-in and hashed and also all output files generated by the BuildXL build have to be analyzed and hashed too.

The application can be ran alongside an existing build and simulates I/O load depending on several config settings and the main input file.

##Input file

The input file is used to describe a list of inputs specified by absolute paths and a list of output directories to be observed while the application is executing. The format is as follows, from an imaginary `input.txt`:

```[Input]
/Users/John/Work/Project/src/a.cpp
/Users/John/Work/Project/src/b.cpp
/Users/John/Work/Project/src/SomeSubfolder/a.cpp
[Output]
/Users/John/Work/Project/out/libraries
/Users/John/Work/Project/out/symbols
/Users/John/Work/Project/out/pictures
```

Here we have defined 3 input files that will be hashed over the duration of the application execution and 3 output folders that will be monitored and if file creations or updates happen, hash those too! Please don't forget to annotate the input and output files with the appropriate section header otherwise the application will not start.

## Benchmark

Because the application tries to approximate possible BuildXL build I/O load, it is important to analyze the machine prior to running it alongside a build. The application has to estimate how many hashes (MD5) it can calculate per second. To do this, it takes a percentage of the input files specified and can run a benchmark. After the benchmark finishes, the application updates its own config file to reflect the estimated hash rate. **Important: do this before the first run!**

```console
./IOSimulator --benchmark input.txt
Running benchmark on 50% of randomized input sources, please be patient...
----------------------------------------------
Hashed:	65299 files
Rate:	699.31245716244 files hashed / second!
----------------------------------------------
Adjusting your /Users/krisso/Downloads/iosimulator/IOSimulator.dll.config please wait... Done!
```

Note: The percentage of files used as a sample from the input can be adjusted in the `IOSimulator.dll.config` file:

`<add key="sample_percentage" value="50" />`

## Execution

Now that the benchmark has been done, the application can be additionally tweaked through settings changes or executed along-side a build or tool, e.g.

```console
./IOSimulator input.txt
--------------------------------------------------------
NOTE: PLEASE RUN THE BENCHMARK ONCE TO ADJUST I/O RATES!
--------------------------------------------------------
Input files:		130632
Input workers:		5
Output directories:	1
Logging enabled:	False
Hash rate:		700 files / second
Duration:		30 seconds
--------------------------------------------------------

Results:
--------------------------------------------------------
Worker #0 hashed:	15301 files
Worker #1 hashed:	11697 files
Worker #2 hashed:	17966 files
Worker #3 hashed:	10802 files
Worker #4 hashed:	20329 files
Inputs hashed:		76095 (58%)
Outputs hashed:		0 (Creates / Updates)
Failed input files:	0
End to end time:	30 seconds
--------------------------------------------------------
```

In this example the duration was configured to be 30 seconds and the benchmark prior to this run estimated a throughput of 700 files hashes / second.

Note: The execution duration can be adjusted inside of `IOSimulator.dll.config` file and the changes will be reflected on the next run.

`<add key="duration" value="30"/> <!-- Seconds -->`

You can also adjust verbosity `verbose`, enable logging `logging`, adjust the concurrent worker count `worker_count` and define a pattern for the output observers `observer_pattern`. All of those values have sensible defaults:

```xml
<add key="verbose" value="false" />
<add key="logging" value="false" />
<add key="worker_count" value="5" />
<add key="observer_pattern" value="*" />
```

If you take a look at the results you will see that in this particular run the execution was canceled after 30 seconds, exactly as specified by the duration setting. The application tries to throttle the hashing execution through simple heuristics too, so the duration should always be met even when there are almost no input files and a long time period is configured and so on.

Some files can't be hashed so the `Inputs hashed` must always correspond to the input files specified. Common issues can be unauthorized accesses or ACLs. IOSimulator skips those files without failing and shows a simple indicator of the number of files that failed. If more information is necessary, the verbose flag in the configuration can help.